<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preaudits - Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #181828;
            color: #fff;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        h1 {
            font-size: 2.2rem;
            font-weight: bold;
            background: linear-gradient(90deg, #ff7ee7, #6a82fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95rem;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-secondary {
            background: #181828;
            border: 1.5px solid #2d2d44;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #2d2d44;
        }

        .card {
            background: #23233a;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 32px rgba(106,130,251,0.1);
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fff;
        }

        /* Input Form */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 16px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 0.9rem;
            color: #b6b6d6;
            font-weight: 500;
        }

        .form-label .required {
            color: #ff7ee7;
        }

        .form-input,
        .form-select {
            padding: 12px 16px;
            border-radius: 8px;
            background: #181828;
            border: 1.5px solid #2d2d44;
            color: #fff;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #6a82fb;
        }

        .btn-primary {
            padding: 12px 40px;
            background: linear-gradient(90deg, #ff7ee7, #6a82fb);
            color: #fff;
            font-weight: 600;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(106,130,251,0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(106,130,251,0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Progress Bar */
        .progress-container {
            display: none;
            margin-bottom: 24px;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #2d2d44;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff7ee7, #6a82fb);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.95rem;
            color: #b6b6d6;
            text-align: center;
        }

        /* Results */
        .results-container {
            display: none;
        }

        .results-container.active {
            display: block;
        }

        .action-notice {
            display: none;
            margin-bottom: 18px;
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(34, 197, 94, 0.10);
            border: 1px solid rgba(74, 222, 128, 0.25);
            color: #bbf7d0;
            font-size: 0.95rem;
        }

        .action-notice.active {
            display: block;
        }

        .action-notice a {
            color: #6a82fb;
            font-weight: 600;
            text-decoration: none;
        }

        .action-notice a:hover {
            color: #ff7ee7;
        }

        .results-section {
            margin-bottom: 32px;
        }

        .results-section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .results-section-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .results-count {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .count-green {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            color: #4ade80;
        }

        .count-red {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            color: #f87171;
        }

        /* Green Results Grid */
        .green-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .result-card {
            background: #2d2d44;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid rgba(74, 222, 128, 0.3);
        }

        .result-screenshot {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
            cursor: pointer;
            background: #181828;
            position: relative;
        }

        .result-screenshot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s;
        }

        .result-screenshot:hover img {
            transform: scale(1.05);
        }

        .result-screenshot-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .result-screenshot:hover .result-screenshot-overlay {
            opacity: 1;
        }

        .result-screenshot-overlay span {
            color: #fff;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .result-info {
            margin-bottom: 12px;
        }

        .result-url {
            font-size: 0.9rem;
            color: #6a82fb;
            text-decoration: none;
            font-weight: 500;
            display: block;
            margin-bottom: 6px;
            word-break: break-all;
        }

        .result-url:hover {
            color: #ff7ee7;
        }

        .result-email {
            font-size: 0.85rem;
            color: #4ade80;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .result-actions {
            display: flex;
            gap: 8px;
        }

        .result-error {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            background: rgba(248, 113, 113, 0.12);
            border: 1px solid rgba(248, 113, 113, 0.25);
            color: #fecaca;
            font-size: 0.85rem;
            line-height: 1.3;
            word-break: break-word;
        }

        .btn-proceed {
            flex: 1;
            padding: 10px;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            color: #fff;
            font-weight: 600;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-proceed:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(74, 222, 128, 0.3);
        }

        .btn-proceed:disabled {
            opacity: 0.75;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-delete {
            padding: 10px 16px;
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            color: #f87171;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-delete:hover {
            background: rgba(248, 113, 113, 0.2);
        }

        /* Red Results List */
        .red-results-list {
            background: #2d2d44;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid rgba(248, 113, 113, 0.3);
        }

        .red-result-item {
            padding: 12px;
            border-bottom: 1px solid #181828;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .red-result-item:last-child {
            border-bottom: none;
        }

        .red-result-icon {
            color: #f87171;
            font-size: 1.1rem;
        }

        .red-result-url {
            flex: 1;
            color: #b6b6d6;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .red-result-reason {
            font-size: 0.8rem;
            color: #f87171;
            padding: 4px 8px;
            background: rgba(248, 113, 113, 0.1);
            border-radius: 4px;
        }

        /* Screenshot Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 90vw;
            max-height: 90vh;
            background: #23233a;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            background: #2d2d44;
            border: 1px solid #4d4d64;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            z-index: 1001;
        }

        .modal-close:hover {
            background: #4d4d64;
        }

        .modal-image {
            width: auto;
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
            margin-top: 40px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #b6b6d6;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        @media (max-width: 1024px) {
            .form-row {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .green-results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="header">
            <h1>Preaudits</h1>
            <div class="header-buttons">
                <a href="/admin/audits" class="btn btn-secondary">Go to Audits</a>
                <a href="/admin" class="btn btn-secondary">Back to Admin</a>
                <a href="/admin/logout" class="btn btn-secondary">Logout</a>
            </div>
        </div>

        <!-- Input Form -->
        <div class="card">
            <h2 class="card-title">A) Input</h2>
            <form id="searchForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            NICHE PRESET <span class="required">*</span>
                        </label>
                        <select name="niche" id="nicheSelect" class="form-select" required>
                            <option value="">Select niche...</option>
                            <% (presets || []).forEach(preset => { %>
                                <option value="<%= preset.slug %>"><%= preset.display_name %></option>
                            <% }); %>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            CITY (Optional)
                        </label>
                        <input 
                            type="text" 
                            name="city" 
                            id="cityInput" 
                            class="form-input"
                            placeholder="e.g. Miami"
                        />
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            COUNT <span class="required">*</span>
                        </label>
                        <input 
                            type="number" 
                            name="count" 
                            id="countInput" 
                            class="form-input"
                            min="1"
                            max="50"
                            value="10"
                            required
                        />
                    </div>

                    <button type="submit" class="btn btn-primary" id="processBtn">
                        Process
                    </button>
                </div>
            </form>
        </div>

        <!-- Progress Bar -->
        <div class="card progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">
                Searching...
            </div>
        </div>

        <!-- Results -->
        <div class="results-container" id="resultsContainer">
            <div class="action-notice" id="actionNotice"></div>
            <!-- Green Results -->
            <div class="results-section">
                <div class="results-section-header">
                    <span class="results-section-title">‚úÖ Valid Results (Has Email)</span>
                    <span class="results-count count-green" id="greenCount">0</span>
                </div>
                <div id="greenResults">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>No results yet. Start a search above.</p>
                    </div>
                </div>
            </div>

            <!-- Red Results -->
            <div class="results-section">
                <div class="results-section-header">
                    <span class="results-section-title">‚ùå Invalid Results (No Email - Blacklisted)</span>
                    <span class="results-count count-red" id="redCount">0</span>
                </div>
                <div id="redResults">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No blacklisted results yet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Screenshot Modal -->
    <div class="modal" id="screenshotModal">
        <div class="modal-content">
            <button class="modal-close" id="closeModalBtn" type="button">‚úï Close</button>
            <img id="modalImage" class="modal-image" src="" alt="Full page screenshot" />
        </div>
    </div>

    <script>
        let currentSearchId = null;
        let pollInterval = null;

        // Form submission
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = {
                niche: formData.get('niche'),
                city: formData.get('city'),
                count: formData.get('count')
            };

            console.log('Starting search:', data);

            // Disable form
            document.getElementById('processBtn').disabled = true;
            document.getElementById('processBtn').textContent = 'Processing...';

            // Show progress
            document.getElementById('progressContainer').classList.add('active');
            document.getElementById('resultsContainer').classList.remove('active');

            try {
                const response = await fetch('/admin/api/preaudits/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Search failed');
                }

                console.log('Search started:', result);
                currentSearchId = result.searchId;

                // Start polling for status
                startPolling();

            } catch (error) {
                console.error('Error starting search:', error);
                alert('Failed to start search: ' + error.message);

                // Reset UI
                document.getElementById('processBtn').disabled = false;
                document.getElementById('processBtn').textContent = 'Process';
                document.getElementById('progressContainer').classList.remove('active');
            }
        });

        // Polling for status
        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);

            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/admin/api/preaudits/${currentSearchId}/status`);
                    const status = await response.json();

                    console.log('Status update:', status);

                    // Update progress
                    if (status.found_count > 0) {
                        const progress = ((status.green_count + status.red_count) / status.found_count) * 100;
                        document.getElementById('progressFill').style.width = progress + '%';
                        document.getElementById('progressText').textContent = 
                            `Processing: ${status.green_count + status.red_count}/${status.found_count} (Green: ${status.green_count}, Red: ${status.red_count})`;
                    }

                    // If completed, load results
                    if (status.status === 'completed' || status.status === 'failed') {
                        clearInterval(pollInterval);
                        
                        if (status.status === 'completed') {
                            await loadResults();
                        } else {
                            alert('Search failed: ' + (status.error_message || 'Unknown error'));
                        }

                        // Reset form
                        document.getElementById('processBtn').disabled = false;
                        document.getElementById('processBtn').textContent = 'Process';
                        document.getElementById('progressContainer').classList.remove('active');
                    }

                } catch (error) {
                    console.error('Polling error:', error);
                    clearInterval(pollInterval);
                }
            }, 2000); // Poll every 2 seconds
        }

        // Load results
        async function loadResults() {
            try {
                const response = await fetch(`/admin/api/preaudits/${currentSearchId}/results`);
                const results = await response.json();

                console.log('Results loaded:', results);

                // Show results container
                document.getElementById('resultsContainer').classList.add('active');

                // Update counts
                document.getElementById('greenCount').textContent = results.green.length;
                document.getElementById('redCount').textContent = results.red.length;

                // Render green results
                renderGreenResults(results.green);

                // Render red results
                renderRedResults(results.red);

            } catch (error) {
                console.error('Error loading results:', error);
                alert('Failed to load results: ' + error.message);
            }
        }

        // Render green results
        function renderGreenResults(results) {
            const container = document.getElementById('greenResults');

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üòû</div>
                        <p>No valid results found (no emails detected)</p>
                    </div>
                `;
                return;
            }

            const html = `
                <div class="green-results-grid">
                    ${results.map(result => `
                        <div class="result-card" data-result-id="${result.id}">
                            <div class="result-screenshot" data-full-path="${result.screenshot_full_path ? `/${result.screenshot_full_path}` : ''}">
                                <img src="/${result.screenshot_hero_path}" alt="Screenshot" loading="lazy" />
                                <div class="result-screenshot-overlay">
                                    <span>${result.screenshot_full_path ? 'üîç Click to view full page' : 'üîç Click to enlarge'}</span>
                                </div>
                            </div>
                            <div class="result-info">
                                <a href="${result.url}" class="result-url" target="_blank">${result.url}</a>
                                <div class="result-email">
                                    <span>‚úâÔ∏è</span>
                                    <span>${result.email}</span>
                                </div>
                            </div>
                            <div class="result-actions">
                                <button class="btn-proceed" type="button" data-action="proceed" data-result-id="${result.id}">
                                    Proceed ‚Üí
                                </button>
                                <button class="btn-delete" type="button" data-action="delete" data-result-id="${result.id}">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            container.innerHTML = html;
        }

        // Render red results
        function renderRedResults(results) {
            const container = document.getElementById('redResults');

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ú®</div>
                        <p>All results had emails!</p>
                    </div>
                `;
                return;
            }

            const html = `
                <div class="red-results-list">
                    ${results.map(result => `
                        <div class="red-result-item">
                            <span class="red-result-icon">‚ùå</span>
                            <span class="red-result-url">${result.url}</span>
                            <span class="red-result-reason">No email found</span>
                        </div>
                    `).join('')}
                </div>
            `;

            container.innerHTML = html;
        }

        // Proceed with result
        async function proceedWithResult(resultId) {
            let proceedBtn = null;
            let card = null;
            try {
                proceedBtn = document.querySelector(`button[data-action="proceed"][data-result-id="${resultId}"]`);
                if (proceedBtn) {
                    proceedBtn.disabled = true;
                    proceedBtn.textContent = 'Creating audit...';
                }

                card = document.querySelector(`[data-result-id="${resultId}"]`);
                if (card) {
                    const existingErr = card.querySelector('.result-error');
                    if (existingErr) existingErr.remove();
                }

                const response = await fetch(`/admin/api/preaudits/${resultId}/proceed`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to proceed');
                }

                console.log('Audit created:', result);

                // Remove from UI
                if (card) {
                    card.style.transition = 'opacity 0.3s, transform 0.3s';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    setTimeout(() => card.remove(), 300);
                }

                // Update count
                const greenCount = document.getElementById('greenCount');
                greenCount.textContent = parseInt(greenCount.textContent) - 1;

                if (proceedBtn) {
                    proceedBtn.textContent = 'Done';
                }

                // Stay on Preaudits page; show inline notice with link
                const notice = document.getElementById('actionNotice');
                if (notice) {
                    const auditId = result.auditJobId || '';
                    const auditLink = auditId ? `/admin/audits/${auditId}` : '/admin/audits';
                    notice.innerHTML = `‚úì Audit created${auditId ? ` (#${auditId})` : ''}. <a href="${auditLink}">Open</a> or use the ‚ÄúGo to Audits‚Äù button.`;
                    notice.classList.add('active');
                    // auto-hide after a few seconds (not a toast; just clears UI)
                    setTimeout(() => {
                        notice.classList.remove('active');
                        notice.innerHTML = '';
                    }, 6000);
                }

            } catch (error) {
                console.error('Error proceeding:', error);
                if (!card) {
                    card = document.querySelector(`[data-result-id="${resultId}"]`);
                }
                if (card) {
                    let errEl = card.querySelector('.result-error');
                    if (!errEl) {
                        errEl = document.createElement('div');
                        errEl.className = 'result-error';
                        card.appendChild(errEl);
                    }
                    errEl.textContent = 'Failed to proceed: ' + error.message;
                }

                if (!proceedBtn) {
                    proceedBtn = document.querySelector(`button[data-action="proceed"][data-result-id="${resultId}"]`);
                }
                if (proceedBtn) {
                    proceedBtn.disabled = false;
                    proceedBtn.textContent = 'Proceed ‚Üí';
                }
            }
        }

        // Delete result
        async function deleteResult(resultId) {
            if (!confirm('Delete this result?\n\nIt will be added to the blacklist and won\'t appear in future searches.')) {
                return;
            }

            try {
                const response = await fetch(`/admin/api/preaudits/${resultId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to delete');
                }

                console.log('Result deleted:', result);

                // Remove from UI
                const card = document.querySelector(`[data-result-id="${resultId}"]`);
                if (card) {
                    card.style.transition = 'opacity 0.3s, transform 0.3s';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    setTimeout(() => card.remove(), 300);
                }

                // Update count
                const greenCount = document.getElementById('greenCount');
                greenCount.textContent = parseInt(greenCount.textContent) - 1;

                // Reload results to show in red list
                await loadResults();

            } catch (error) {
                console.error('Error deleting:', error);
                alert('Failed to delete: ' + error.message);
            }
        }

        // Screenshot modal
        function openModal(imagePath) {
            if (!imagePath) return;
            document.getElementById('modalImage').src = imagePath;
            document.getElementById('screenshotModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('screenshotModal').classList.remove('active');
        }

        // Bind close button (CSP-safe; no inline handlers)
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);

        // Event delegation for dynamic green results (CSP-safe; no inline handlers)
        document.getElementById('greenResults').addEventListener('click', (e) => {
            const screenshotEl = e.target.closest('.result-screenshot');
            if (screenshotEl) {
                const fullPath = screenshotEl.getAttribute('data-full-path');
                // If full screenshot is disabled, fall back to the hero image
                if (fullPath) {
                    openModal(fullPath);
                } else {
                    const heroImg = screenshotEl.querySelector('img');
                    if (heroImg && heroImg.getAttribute('src')) openModal(heroImg.getAttribute('src'));
                }
                return;
            }

            const actionBtn = e.target.closest('button[data-action]');
            if (!actionBtn) return;

            const action = actionBtn.getAttribute('data-action');
            const resultId = parseInt(actionBtn.getAttribute('data-result-id'), 10);
            if (!resultId) return;

            if (action === 'proceed') {
                proceedWithResult(resultId);
            } else if (action === 'delete') {
                deleteResult(resultId);
            }
        });

        // Close modal on click outside
        document.getElementById('screenshotModal').addEventListener('click', (e) => {
            if (e.target.id === 'screenshotModal') {
                closeModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
