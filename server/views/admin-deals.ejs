<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deal Threads — Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #f7f8fa; color: #111827; min-height: 100vh; -webkit-font-smoothing: antialiased; }

    .topbar {
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      padding: 0 24px;
      height: 60px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .back-btn {
      font-size: 13px; font-weight: 500; color: #6b7280;
      text-decoration: none; padding: 5px 10px; border-radius: 8px;
      display: inline-flex; align-items: center; gap: 5px;
      transition: background 0.15s, color 0.15s;
    }
    .back-btn:hover { background: #f3f4f6; color: #374151; }
    .topbar-divider { width: 1px; height: 20px; background: #e5e7eb; }
    .topbar-title { font-size: 15px; font-weight: 600; color: #111827; flex: 1; }
    .btn-primary {
      display: inline-flex; align-items: center; gap: 6px;
      background: #6366f1; color: #fff; border: none; border-radius: 9px;
      padding: 8px 16px; font-size: 13px; font-weight: 600; font-family: inherit;
      cursor: pointer; text-decoration: none; transition: background 0.15s;
    }
    .btn-primary:hover { background: #4f46e5; }

    .page { max-width: 960px; margin: 0 auto; padding: 28px 24px; }

    /* Alerts */
    .alert { padding: 10px 14px; border-radius: 10px; font-size: 13px; font-weight: 500; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
    .alert-error { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
    .alert-success { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }

    /* Stats */
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .stat {
      background: #fff; border: 1px solid #e5e7eb; border-radius: 12px;
      padding: 16px 18px;
    }
    .stat-label { font-size: 11px; font-weight: 600; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 26px; font-weight: 700; color: #111827; margin-top: 4px; }
    .stat-value.green { color: #16a34a; }
    .stat-value.gray { color: #9ca3af; }

    /* Table */
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; overflow: hidden; }

    table { width: 100%; border-collapse: collapse; }
    thead th {
      text-align: left; padding: 12px 18px;
      font-size: 11px; font-weight: 700; color: #6b7280;
      text-transform: uppercase; letter-spacing: 0.5px;
      border-bottom: 1px solid #f3f4f6; white-space: nowrap;
      background: #f9fafb;
    }
    tbody tr { border-bottom: 1px solid #f3f4f6; transition: background 0.1s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: #fafafa; }
    td { padding: 14px 18px; font-size: 13px; color: #374151; vertical-align: middle; }

    .deal-name a { font-weight: 600; color: #111827; text-decoration: none; }
    .deal-name a:hover { color: #6366f1; }
    .deal-date { font-size: 11px; color: #9ca3af; margin-top: 2px; }

    .client-name { font-weight: 600; color: #111827; }
    .client-email { font-size: 11px; color: #9ca3af; margin-top: 2px; }

    .status-badge {
      display: inline-flex; align-items: center; gap: 5px;
      font-size: 11px; font-weight: 600; padding: 3px 9px; border-radius: 20px;
    }
    .status-active { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
    .status-closed { background: #f9fafb; color: #9ca3af; border: 1px solid #e5e7eb; }

    .msg-count { font-size: 13px; color: #6b7280; display: flex; align-items: center; gap: 4px; }

    .btn-open {
      display: inline-block; padding: 5px 12px; border-radius: 7px;
      background: #f5f3ff; color: #5b21b6; font-size: 12px; font-weight: 600;
      text-decoration: none; transition: background 0.15s;
    }
    .btn-open:hover { background: #ede9fe; }

    /* Empty */
    .empty { text-align: center; padding: 60px 32px; }
    .empty-icon {
      width: 52px; height: 52px; border-radius: 14px;
      background: linear-gradient(135deg, #ede9fe, #ddd6fe);
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 14px;
    }
    .empty-icon svg { width: 24px; height: 24px; color: #7c3aed; }
    .empty h3 { font-size: 15px; font-weight: 600; color: #374151; margin-bottom: 6px; }
    .empty p { font-size: 13px; color: #9ca3af; margin-bottom: 20px; }
  </style>
</head>
<body>

<div class="topbar">
  <a href="/admin" class="back-btn">
    <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
    Admin
  </a>
  <div class="topbar-divider"></div>
  <span class="topbar-title">Deal Threads</span>
  <a href="/admin/deals/new" class="btn-primary">
    <svg width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
    New Deal
  </a>
</div>

<div class="page">
  <% if (error) { %><div class="alert alert-error"><%= error %></div><% } %>
  <% if (success) { %><div class="alert alert-success"><%= success %></div><% } %>

  <%
    const active = deals.filter(d => d.status === 'active').length;
    const closed = deals.filter(d => d.status === 'closed').length;
    const totalMsgs = deals.reduce((s, d) => s + (d.message_count || 0), 0);
  %>
  <div class="stats">
    <div class="stat"><div class="stat-label">Total</div><div class="stat-value"><%= deals.length %></div></div>
    <div class="stat"><div class="stat-label">Active</div><div class="stat-value green"><%= active %></div></div>
    <div class="stat"><div class="stat-label">Closed</div><div class="stat-value gray"><%= closed %></div></div>
    <div class="stat"><div class="stat-label">Messages</div><div class="stat-value"><%= totalMsgs %></div></div>
  </div>

  <div class="card">
    <% if (deals.length === 0) { %>
      <div class="empty">
        <div class="empty-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg></div>
        <h3>No deals yet</h3>
        <p>Create your first secure client thread.</p>
        <a href="/admin/deals/new" class="btn-primary">Create First Deal</a>
      </div>
    <% } else { %>
    <table>
      <thead>
        <tr>
          <th>Deal</th>
          <th>Client</th>
          <th>Status</th>
          <th>Messages</th>
          <th>Last activity</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% deals.forEach(function(deal) { %>
        <tr>
          <td class="deal-name">
            <a href="/admin/deals/<%= deal.id %>"><%= deal.title %></a>
            <div class="deal-date"><%= new Date(deal.created_at).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) %></div>
          </td>
          <td>
            <div class="client-name"><%= deal.client_name %></div>
            <div class="client-email"><%= deal.client_email %></div>
          </td>
          <td>
            <span class="status-badge <%= deal.status === 'active' ? 'status-active' : 'status-closed' %>">
              <svg width="5" height="5" viewBox="0 0 6 6" fill="currentColor"><circle cx="3" cy="3" r="3"/></svg>
              <%= deal.status === 'active' ? 'Active' : 'Closed' %>
            </span>
          </td>
          <td><span class="msg-count"><%= deal.message_count || 0 %></span></td>
          <td style="font-size:12px;color:#9ca3af;">
            <%= deal.last_message_at ? new Date(deal.last_message_at).toLocaleString('en-GB', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : '—' %>
          </td>
          <td><a href="/admin/deals/<%= deal.id %>" class="btn-open">Open →</a></td>
        </tr>
        <% }); %>
      </tbody>
    </table>
    <% } %>
  </div>
</div>
</body>
</html>
