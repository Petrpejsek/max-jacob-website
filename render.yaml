services:
  - type: web
    name: max-jacob-website
    env: node
    # Install deps + ensure Playwright Chromium exists in production
    buildCommand: npm install && npx playwright install --with-deps chromium
    startCommand: npm start
    # CRITICAL: Persistent disk for database and uploaded files
    # Without this, database is wiped on every deployment!
    disk:
      name: data
      mountPath: /opt/render/project/data
      sizeGB: 10
    envVars:
      - key: NODE_ENV
        value: production
      # OOM Fix: Set heap limit to 400MB (leave 112MB for system/Chromium on 512MB tier)
      # Chromium needs ~80-100MB outside Node heap, so we reserve more headroom.
      # --expose-gc allows manual GC after heavy operations.
      - key: NODE_OPTIONS
        value: "--max-old-space-size=400 --expose-gc"
      # OOM Fix: Disable full-page screenshots to save ~150MB (5-20MB per screenshot)
      # Set to "true" to re-enable if needed for specific audits.
      - key: ENABLE_FULLPAGE_SCREENSHOTS
        value: "false"
      # CRITICAL: Database and public files MUST be on persistent disk
      # These paths point to the mounted disk to prevent data loss on deployment
      - key: DB_PATH
        value: "/opt/render/project/data/data.db"
      - key: PUBLIC_DIR
        value: "/opt/render/project/data/public"
      # Preaudits: fullpage screenshots for modal review (can be toggled off if memory is tight)
      - key: ENABLE_PREAUDIT_FULLPAGE_SCREENSHOTS
        value: "true"
      # IMPORTANT: Secrets MUST be set in the Render dashboard (or your VPS env),
      # never committed to git.
      # Required:
      # - ADMIN_PASSWORD
      # - SESSION_SECRET
      # - OPENROUTER_API_KEY (for audits)
      # PORT je automaticky nastavený Renderem, nepotřebujeme ho explicitně nastavovat
    healthCheckPath: /health
    autoDeploy: true
